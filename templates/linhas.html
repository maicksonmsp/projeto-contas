{% extends "base.html" %}

{% block title %}Linhas - PEIXOTO GRUPO EMPRESARIAL{% endblock %}

{% block content %}
<style>
    .page-header {
        margin-bottom: 2rem;
    }
    
    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }
    
    .page-subtitle {
        color: var(--primary-muted);
        font-size: 0.875rem;
    }
    
    .search-container {
        background: white;
        border: 1px solid var(--primary-border);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .table-container {
        background: white;
        border: 1px solid var(--primary-border);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table-header {
        background: var(--gray-50);
        padding: 1rem;
        border-bottom: 1px solid var(--primary-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-badge {
        padding: 0.25rem 0.625rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .badge-ativa {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }
    
    .badge-cancelar {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    
    .badge-cancelada {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    
    .badge-sim {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
    
    .badge-nao {
        background: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
    
    .badge-departamento {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
    
    .badge-fase {
        background: #f3e8ff;
        color: #7c3aed;
        border: 1px solid #c4b5fd;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }
    
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--primary-muted);
    }
    
    .money-value {
        font-weight: 600;
        color: var(--primary-text);
        font-family: 'SF Mono', Monaco, 'Cascadia Mono', monospace;
        font-size: 0.875rem;
    }
    
    /* ESTILOS ADICIONADOS PARA ORDENAÇÃO */
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
    }
    
    .sortable-header:hover {
        background-color: var(--gray-100);
    }
    
    .sortable-header::after {
        content: '↕';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.75rem;
        opacity: 0.5;
    }
    
    .sortable-header.sort-asc::after {
        content: '↑';
        opacity: 1;
        color: var(--primary);
    }
    
    .sortable-header.sort-desc::after {
        content: '↓';
        opacity: 1;
        color: var(--primary);
    }
    
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.8125rem;
        }
    }
</style>

<div class="container-fluid">
    <!-- CABEÇALHO -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="page-title">Linhas Telefônicas</h1>
                <p class="page-subtitle">Gerencie todas as linhas do sistema</p>
            </div>
            <div>
                <a href="{{ url_for('adicionar_linha') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Nova Linha
                </a>
            </div>
        </div>
    </div>

    <!-- BARRA DE BUSCA -->
    <div class="search-container">
        <form method="GET" action="{{ url_for('listar_linhas') }}" class="row g-2">
            <div class="col-md-8">
                <input type="text" 
                       name="search" 
                       class="form-control" 
                       placeholder="Buscar por conta, linha, responsável, departamento..." 
                       value="{{ search }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>Buscar
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ url_for('listar_linhas') }}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-x-circle me-1"></i>Limpar
                </a>
            </div>
        </form>
    </div>

    <!-- TABELA -->
    <div class="table-container">
        <div class="table-header d-flex justify-content-between align-items-center">
            <div>
                <strong>Lista de Linhas</strong>
                <span class="text-muted ms-2" style="font-size: 0.875rem;">
                    {% if pagination %}
                        {{ pagination.total }} linha{{ 's' if pagination.total != 1 else '' }}
                    {% else %}
                        {{ linhas|length }} linha{{ 's' if linhas|length != 1 else '' }}
                    {% endif %}
                </span>
            </div>
            <div>
                <a href="{{ url_for('exportar_linhas') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-download me-1"></i>Exportar
                </a>
            </div>
        </div>
        
        {% if linhas %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="linhasTable">
                <thead>
                    <tr>
                        <th class="sortable-header" data-column="conta">Conta</th>
                        <th class="sortable-header" data-column="linha">Linha</th>
                        <th class="sortable-header" data-column="plano">Plano</th>
                        <th class="sortable-header" data-column="mensalidade">Mensalidade</th>
                        <th class="sortable-header" data-column="responsavel">Responsável</th>
                        <th class="sortable-header" data-column="departamento">Departamento</th>
                        <th class="sortable-header" data-column="chipeira">Chipeira</th>
                        <th class="sortable-header" data-column="efetivacao">Efetivação</th>
                        <th class="sortable-header" data-column="termino">Término</th>
                        <th class="sortable-header" data-column="status">Status</th>
                        <th class="sortable-header" data-column="uso">Em Uso</th>
                        <th class="sortable-header" data-column="fase">Fase</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for linha in linhas %}
                    <tr>
                        <td class="fw-medium">{{ linha.conta }}</td>
                        <td>{{ linha.linha|format_phone }}</td>
                        <td>{{ linha.plano }}</td>
                        <td class="money-value">R$ {{ linha.mensalidade|format_currency }}</td>
                        <td>{{ linha.responsavel }}</td>
                        <td>
                            <span class="badge-departamento">{{ linha.departamento }}</span>
                        </td>
                        <td>
                            {% if linha.chipeira == 'Sim' %}
                                <span class="badge-sim">{{ linha.chipeira }}</span>
                            {% else %}
                                <span class="badge-nao">{{ linha.chipeira }}</span>
                            {% endif %}
                        </td>
                        <td>{{ linha.efetivacao|format_date }}</td>
                        <td>{{ linha.termino|format_date }}</td>
                        <td>
                            {% if linha.status == 'Ativa' %}
                                <span class="status-badge badge-ativa">{{ linha.status }}</span>
                            {% elif linha.status == 'A Cancelar' %}
                                <span class="status-badge badge-cancelar">{{ linha.status }}</span>
                            {% else %}
                                <span class="status-badge badge-cancelada">{{ linha.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if linha.uso == 'Sim' %}
                                <span class="badge-sim">{{ linha.uso }}</span>
                            {% else %}
                                <span class="badge-nao">{{ linha.uso }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if linha.fase %}
                                <span class="badge-fase">{{ linha.fase }}</span>
                            {% else %}
                                <span class="text-muted" style="font-size: 0.75rem;">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="d-flex justify-content-end gap-1">
                                <a href="{{ url_for('editar_linha', id=linha.id) }}" 
                                   class="btn btn-outline-primary btn-sm action-btn"
                                   title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" 
                                        class="btn btn-outline-danger btn-sm action-btn"
                                        onclick="confirmarExclusao({{ linha.id }}, '{{ linha.conta }} - {{ linha.linha|format_phone }}')"
                                        title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- PAGINAÇÃO -->
        {% if pagination and pagination.pages > 1 %}
        <div class="p-3 border-top">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted" style="font-size: 0.875rem;">
                    Mostrando {{ pagination.first }} - {{ pagination.last }} de {{ pagination.total }} linha{{ 's' if pagination.total != 1 else '' }}
                </div>
                <nav>
                    <ul class="pagination mb-0">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pagination.prev_num }}{% if search %}&search={{ search }}{% endif %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                    <a class="page-link" href="?page={{ page_num }}{% if search %}&search={{ search }}{% endif %}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pagination.next_num }}{% if search %}&search={{ search }}{% endif %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
            <h5 class="mb-2">Nenhuma linha encontrada</h5>
            <p class="text-muted mb-3">Comece adicionando sua primeira linha</p>
            <a href="{{ url_for('adicionar_linha') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Adicionar Linha
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function confirmarExclusao(id, nome) {
    if (confirm(`Tem certeza que deseja excluir a linha "${nome}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/linhas/excluir/${id}`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = "{{ csrf_token() }}";
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// FUNCIONALIDADE DE ORDENAÇÃO ADICIONADA
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('linhasTable');
    if (!table) return;
    
    const tbody = document.getElementById('tableBody');
    const headers = table.querySelectorAll('.sortable-header');
    
    let currentSort = {
        column: null,
        direction: 'asc'
    };
    
    // Adiciona event listeners aos cabeçalhos
    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            sortTable(column);
        });
    });
    
    function sortTable(column) {
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Remove classes de ordenação anteriores
        headers.forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Define a direção da ordenação
        let direction = 'asc';
        if (currentSort.column === column && currentSort.direction === 'asc') {
            direction = 'desc';
        }
        
        // Atualiza o estado atual
        currentSort.column = column;
        currentSort.direction = direction;
        
        // Adiciona classe ao cabeçalho atual
        const currentHeader = table.querySelector(`th[data-column="${column}"]`);
        if (currentHeader) {
            currentHeader.classList.add(`sort-${direction}`);
        }
        
        // Ordena as linhas
        rows.sort((a, b) => {
            const aCell = getCellValue(a, column);
            const bCell = getCellValue(b, column);
            
            const aValue = convertValue(aCell, column);
            const bValue = convertValue(bCell, column);
            
            if (direction === 'asc') {
                return compareValues(aValue, bValue);
            } else {
                return compareValues(bValue, aValue);
            }
        });
        
        // Remove linhas antigas
        rows.forEach(row => tbody.removeChild(row));
        
        // Adiciona linhas ordenadas
        rows.forEach(row => {
            tbody.appendChild(row);
        });
    }
    
    function getCellValue(row, column) {
        const headers = Array.from(table.querySelectorAll('th'));
        const columnIndex = headers.findIndex(h => h.getAttribute('data-column') === column);
        
        if (columnIndex === -1) return '';
        
        const cell = row.cells[columnIndex];
        if (!cell) return '';
        
        // Extrai texto de badges
        if (cell.querySelector('.badge-departamento, .badge-fase, .status-badge, .badge-sim, .badge-nao')) {
            const badge = cell.querySelector('.badge-departamento, .badge-fase, .status-badge, .badge-sim, .badge-nao');
            return badge ? badge.textContent.trim() : cell.textContent.trim();
        }
        
        return cell.textContent.trim();
    }
    
    function convertValue(value, column) {
        if (!value) return '';
        
        // Converte valores monetários (R$ 48,08)
        if (column === 'mensalidade') {
            const num = parseFloat(value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
            return isNaN(num) ? 0 : num;
        }
        
        // Converte datas (formato dd/mm/yyyy)
        if (column === 'efetivacao' || column === 'termino') {
            if (!value || value === '-') return '';
            const parts = value.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return value;
        }
        
        // Define ordem para status
        if (column === 'status') {
            const statusOrder = {
                'Ativa': 1,
                'A Cancelar': 2,
                'Cancelada': 3
            };
            return statusOrder[value] || 99;
        }
        
        // Define ordem para Sim/Não
        if (column === 'chipeira' || column === 'uso') {
            const order = { 'Sim': 1, 'Não': 2 };
            return order[value] || 99;
        }
        
        // Converte números
        if (column === 'conta') {
            const num = parseInt(value);
            return isNaN(num) ? value : num;
        }
        
        // Para telefone, remover formatação para ordenação
        if (column === 'linha') {
            return value.replace(/\D/g, '');
        }
        
        // Converte para minúsculas para ordenação de texto
        return value.toString().toLowerCase();
    }
    
    function compareValues(a, b) {
        if (a === b) return 0;
        
        // Comparação numérica
        if (typeof a === 'number' && typeof b === 'number') {
            return a - b;
        }
        
        // Números vêm antes de strings
        if (typeof a === 'number' && typeof b !== 'number') return -1;
        if (typeof a !== 'number' && typeof b === 'number') return 1;
        
        // Comparação de strings
        if (typeof a === 'string' && typeof b === 'string') {
            // Para datas no formato YYYY-MM-DD
            if (/^\d{4}-\d{2}-\d{2}$/.test(a) && /^\d{4}-\d{2}-\d{2}$/.test(b)) {
                return a.localeCompare(b);
            }
            // Para texto em português
            return a.localeCompare(b, 'pt-BR', { sensitivity: 'base' });
        }
        
        return String(a).localeCompare(String(b));
    }
});
</script>
{% endblock %}